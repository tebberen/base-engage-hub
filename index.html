<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Base Engage Hub</title>
  <style>
    body {
      background-color: #ffffff;
      font-family: Arial, sans-serif;
      text-align: center;
      color: #1d4ed8;
      margin: 0;
      padding: 0;
    }
    header {
      background: #1d4ed8;
      color: white;
      padding: 20px;
      font-size: 24px;
      font-weight: bold;
    }
    .subheader {
      margin: 10px 0 30px 0;
      font-size: 18px;
      color: #1d4ed8;
    }
    .link-card {
      border: 1px solid #1d4ed8;
      margin: 15px auto;
      padding: 15px;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
      background-color: #f8fafc;
    }
    button {
      background: #1d4ed8;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #1e40af;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    input {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #1d4ed8;
      width: 80%;
      max-width: 400px;
      margin: 10px 0;
    }
    .wallet-info {
      margin: 10px 0;
      padding: 10px;
      background-color: #dbeafe;
      border-radius: 6px;
    }
    .connect-btn {
      background: #10b981;
      margin: 10px 0;
    }
    .support-link {
      color: #1d4ed8;
      text-decoration: none;
      word-break: break-all;
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .link-platform {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      font-weight: bold;
    }
    .step-indicator {
      margin: 20px 0;
      font-weight: bold;
      color: #1d4ed8;
    }
    .support-required {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      padding: 15px;
      margin: 20px auto;
      width: 80%;
      max-width: 500px;
      border-radius: 8px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <header>Base Engage Hub</header>
  <div class="subheader">If you want support, support first</div>

  <!-- Wallet Connection -->
  <div>
    <button id="connectWalletBtn" class="connect-btn">Connect MetaMask</button>
    <div id="walletInfo" class="wallet-info hidden">
      Connected: <span id="walletAddress"></span>
    </div>
  </div>

  <!-- Step 1: Support Required -->
  <div id="step1" class="support-required">
    <h3>ðŸ“‹ Step 1: Support Others First</h3>
    <p>To submit your link, you must first support at least one community member</p>
    
    <div id="linksContainer">
      <!-- Links will be loaded here -->
    </div>
  </div>

  <!-- Step 2: Submit Your Link -->
  <div id="step2" class="hidden">
    <h3>ðŸŽ‰ Step 2: Submit Your Link</h3>
    <p>Thank you for supporting the community! Now you can submit your own link.</p>
    
    <input type="text" placeholder="Paste your link here (X, Farcaster, GitHub, etc.)" id="userLink" />
    <button id="submitLinkBtn">Submit & Sign with MetaMask</button>
    <p><small>You'll need to sign a message with MetaMask (free - no gas fee)</small></p>
  </div>

  <!-- Submitted Links Section -->
  <h2>Community Links</h2>
  <div id="submittedLinks">
    <!-- Submitted links will appear here -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    let provider;
    let signer;
    let isConnected = false;
    let userAddress = '';
    let hasSupported = false;
    const CONTRACT_ADDRESS = "0x9c05bea4a19de45fe9c8c5541dd4ec6c500f2f3f";

    // Sample links - in real app, these would come from contract/backend
    let supportLinks = [
      "https://x.com/base/status/1967574124819042621?s=46&t=l2lmnRZcmeoUCu9IdzeRpA",
      "https://warpcast.com/~/compose?text=Check%20out%20Base%20Engage%20Hub!",
      "https://github.com/base-org"
    ];

    let submittedLinks = [];

    function getPlatformName(url) {
      if (url.includes('x.com') || url.includes('twitter.com')) return 'ðŸ¦ X (Twitter)';
      if (url.includes('farcaster') || url.includes('warpcast.com')) return 'ðŸ”® Farcaster';
      if (url.includes('github.com')) return 'ðŸ’» GitHub';
      if (url.includes('youtube.com')) return 'ðŸ“º YouTube';
      if (url.includes('discord.com')) return 'ðŸ’¬ Discord';
      return 'ðŸŒ Website';
    }

    function displaySupportLinks() {
      const container = document.getElementById('linksContainer');
      container.innerHTML = '';
      
      supportLinks.forEach((link, index) => {
        const platform = getPlatformName(link);
        const linkCard = document.createElement('div');
        linkCard.className = 'link-card';
        linkCard.innerHTML = `
          <div class="link-platform">${platform}</div>
          <a href="${link}" target="_blank" class="support-link">
            ${link}
          </a>
          <button class="supportBtn" data-link="${link}">Support This Link</button>
        `;
        container.appendChild(linkCard);
      });
    }

    function displaySubmittedLinks() {
      const container = document.getElementById('submittedLinks');
      container.innerHTML = '';
      
      if (submittedLinks.length === 0) {
        container.innerHTML = '<p>No links submitted yet. Be the first!</p>';
        return;
      }
      
      submittedLinks.forEach((link, index) => {
        const platform = getPlatformName(link);
        const linkCard = document.createElement('div');
        linkCard.className = 'link-card';
        linkCard.innerHTML = `
          <div class="link-platform">${platform}</div>
          <a href="${link}" target="_blank" class="support-link">
            ${link}
          </a>
        `;
        container.appendChild(linkCard);
      });
    }

    function checkMetaMask() {
      if (typeof window.ethereum === 'undefined') {
        alert("MetaMask not detected. Please install MetaMask first.");
        return false;
      }
      return true;
    }

    async function connectWallet() {
      if (!checkMetaMask()) return false;

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        
        document.getElementById('walletAddress').textContent = 
          `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
        document.getElementById('walletInfo').classList.remove('hidden');
        document.getElementById('connectWalletBtn').textContent = 'Connected';
        document.getElementById('connectWalletBtn').disabled = true;
        
        isConnected = true;
        return true;
        
      } catch (error) {
        console.error("Connection error:", error);
        if (error.code === 4001) {
          alert("Connection rejected. Please connect to continue.");
        } else {
          alert("Connection failed: " + error.message);
        }
        return false;
      }
    }

    function markAsSupported() {
      hasSupported = true;
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
      alert("âœ… Thank you for supporting! You can now submit your own link.");
    }

    function sendSupport(event) {
      const link = event.target.getAttribute('data-link');
      if (link) {
        window.open(link, '_blank');
        markAsSupported();
      }
    }

    async function submitLink() {
      if (!isConnected) {
        const connected = await connectWallet();
        if (!connected) return;
      }

      if (!hasSupported) {
        alert("Please support at least one community member first!");
        return;
      }

      const userLink = document.getElementById("userLink").value.trim();
      if (!userLink) {
        alert("Please enter your link first.");
        return;
      }

      if (!userLink.startsWith('http://') && !userLink.startsWith('https://')) {
        alert("Please enter a valid URL starting with http:// or https://");
        return;
      }

      try {
        // Sign message with MetaMask (free - no gas)
        const message = `I verify that I want to submit this link to Base Engage Hub: ${userLink}`;
        const signature = await signer.signMessage(message);
        
        alert("âœ… Link submitted successfully with signature!");
        
        // Add to submitted links
        submittedLinks.push(userLink);
        displaySubmittedLinks();
        
        // Reset form
        document.getElementById("userLink").value = "";
        hasSupported = false;
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step1').classList.remove('hidden');
        
        console.log("Signature:", signature);
        console.log("User Address:", userAddress);
        console.log("Submitted Link:", userLink);
        
        // In real app, you would send signature + link to backend/contract
        // await saveToContract(userLink, signature);
        
      } catch (error) {
        console.error("Submit error:", error);
        if (error.code === 4001) {
          alert("Signature rejected. Please try again.");
        } else {
          alert("Submission failed: " + error.message);
        }
      }
    }

    async function saveToContract(link, signature) {
      // This would be your contract interaction
      const contract = new ethers.Contract(CONTRACT_ADDRESS, [
        "function submitLinkWithSignature(string memory _link, bytes memory _signature) public"
      ], signer);

      const tx = await contract.submitLinkWithSignature(link, signature, { 
        gasLimit: 200000 
      });
      await tx.wait();
    }

    // Event listeners
    document.getElementById("connectWalletBtn").addEventListener("click", connectWallet);
    document.getElementById("submitLinkBtn").addEventListener("click", submitLink);

    // Event delegation for support buttons
    document.getElementById('linksContainer').addEventListener('click', function(event) {
      if (event.target.classList.contains('supportBtn')) {
        sendSupport(event);
      }
    });

    // Initialize
    window.addEventListener('load', function() {
      displaySupportLinks();
      displaySubmittedLinks();
      
      // Check for existing wallet connection
      if (checkMetaMask()) {
        setTimeout(async () => {
          try {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            const accounts = await provider.listAccounts();
            
            if (accounts.length > 0) {
              signer = provider.getSigner();
              userAddress = await signer.getAddress();
              
              document.getElementById('walletAddress').textContent = 
                `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
              document.getElementById('walletInfo').classList.remove('hidden');
              document.getElementById('connectWalletBtn').textContent = 'Connected';
              document.getElementById('connectWalletBtn').disabled = true;
              
              isConnected = true;
            }
          } catch (error) {
            console.log("No previous connection found");
          }
        }, 1000);
      }
    });

    // Listen for account changes
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', function(accounts) {
        if (accounts.length === 0) {
          // User disconnected
          isConnected = false;
          hasSupported = false;
          document.getElementById('walletInfo').classList.add('hidden');
          document.getElementById('connectWalletBtn').textContent = 'Connect MetaMask';
          document.getElementById('connectWalletBtn').disabled = false;
          document.getElementById('step2').classList.add('hidden');
          document.getElementById('step1').classList.remove('hidden');
        } else {
          window.location.reload();
        }
      });
    }
  </script>
</body>
</html>
